{% load static %}

<!DOCTYPE html>
<html>

<head>
    <title>ESTI Canteen - Real-time Orders</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="{% static 'canteen/w3.css' %}" />
    <script rel="script" src="{% static 'canteen/jquery.min.js' %}"></script>
    <style>
        #orders {
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <header class="w3-container w3-center w3-padding-32 w3-black">
        <h1>Real-time <span class="w3-tag w3-orange w3-round-large">Orders</span></h1>
        <a href="{% url 'canteen:home' %}" class="w3-padding">Home</a>
        <a href="/admin/" class="w3-padding">Manage</a>
    </header>
    <article class="w3-container w3-padding-32">
        <div class="w3-content">
            <h3>These are the current orders.</h3>
            <div id="orders"></div>
        </div>
    </article>
    <script>
        function markServed(id) {
            $.get('/api-mark-as-served/' + id + '/');
            structureOrders();
        }
        function structureOrders() {
            $.get("{% url 'canteen:json-orders' %}", function (data, status) {
                var table = $(
                    '<table class="w3-table-all w3-bottombar">' +
                    '<tr class="w3-black">' +
                    '<th class="w3-center w3-border">Name</th>' +
                    '<th class="w3-center w3-border">ID No.</th>' +
                    '<th class="w3-center w3-border">Dish</th>' +
                    '<th class="w3-center w3-border">Quantity</th>' +
                    '<th class="w3-center w3-border">Amount to Pay</th>' +
                    '<th class="w3-center w3-border">Date & Time</th>' +
                    '<th class="w3-center w3-border">Served</th>' +
                    '<th class="w3-center w3-border">Action</th>' +
                    '</tr>' +
                    '</table>');
                for (var o in data) {
                    var tr = $('<tr></tr>');
                    tr.append($('<td class="w3-center w3-border">' + data[o].name + '</td>'));
                    tr.append($('<td class="w3-center w3-border">' + data[o].id_no + '</td>'));
                    tr.append($('<td class="w3-center w3-border">' + data[o].dish + '</td>'));
                    tr.append($('<td class="w3-center w3-border">' + data[o].count + '</td>'));
                    tr.append($('<td class="w3-center w3-border">' + data[o].amount + ' pesos</td>'));
                    tr.append($('<td class="w3-center w3-border">' +
                        new Date(data[o].date).toLocaleString() + '</td>'));
                    tr.append($('<td class="w3-center w3-border">'
                        + String(data[o].served ?
                            '<span class="w3-tag w3-blue w3-round-xxlarge">Yes</span>' :
                            '<span class="w3-tag w3-red w3-round-xxlarge">No</span>') +
                        '</td>'));
                    tr.append($('<td class="w3-center w3-border">' +
                        '<button class="w3-button w3-round w3-orange" onclick="markServed('
                        + data[o].id +
                        ')">Toggle Served</button>'
                        + '</td>'));
                    table.append(tr);
                }
                $('#orders').html(table);
            })
        }
        $(document).ready(function () {
            setInterval(structureOrders, 1000)
        })
    </script>
</body>

</html>